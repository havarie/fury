"use strict";var functions=require("firebase-functions"),admin=require("firebase-admin"),serviceAccount=require("./diary-7919f-firebase-adminsdk-xp9f8-c1c1052d38.json"),app=admin.initializeApp({credential:admin.credential.cert(serviceAccount),databaseURL:"https://diary-7919f.firebaseio.com"}),db=admin.firestore(app),messaging=admin.messaging(app),cors=require("cors")({origin:!0}),express=require("express"),appMemories=express(),authenticate=function(o,n,r){if(!o.headers.authorization||!o.headers.authorization.startsWith("Bearer "))return console.log("Unauthorized"),void n.status(203).json({error:{message:"No authorization information sent.",status:"UNAUTHENTICATED"},message:"No authorization information sent."});var e=o.headers.authorization.substring("Bearer ".length);admin.auth().verifyIdToken(e).then(function(e){return o.uid=e.uid,r()}).catch(function(e){console.log("Error, prob not authenticated"),n.status(203).json({error:{message:"Not authorized",status:"UNAUTHENTICATED"},message:"Not authorized"})})};appMemories.use(authenticate),appMemories.post("/newVideo",function(e,o){cors(e,o,function(){return o.status(200).json({isError:!1,signedUrl:url})})});var memoriesRef=db.collection("memories"),usersRef=db.collection("users");exports.helloWorld=functions.https.onRequest(function(e,o){return memoriesRef.where("notificationSent","==",!1).get().then(function(e){var t=[];return e.forEach(function(e){var o=e.data(),n=o.owner,r=o.type,s=o.videoName;t.push({ownerUid:n,mediaType:r,videoName:s})}),t}).then(function(r){var o=[];return r.forEach(function(e){console.log("add to list "+e.ownerUid),o.push(usersRef.doc(e.ownerUid).get())}),Promise.all(o).then(function(e){for(console.log("userDatas"),console.log(e),i=0;i<e.length;i++){var o={notification:{title:"Test!",body:"".concat(r[i].videoName," notifs.")}};console.log("userDatas[i]"),console.log(i),console.log(e[i]),console.log(e[i].data());var n=e[i].data().notificationTokens;return console.log("gooooo"),console.log(o),console.log(n),messaging.sendToDevice(n,o).then(function(e){console.log("notif-response"),console.log(e);var o=e.results;return console.log("results"),console.log(o),console.log("resultend"),e.results.forEach(function(e,o){var n=e.error;console.log("error"),console.log(n),console.log("enderror")}),"fssdfff"})}return"asdffff"})})});