"use strict";var functions=require("firebase-functions"),admin=require("firebase-admin"),serviceAccount=require("./diary-7919f-firebase-adminsdk-xp9f8-c1c1052d38.json"),app=admin.initializeApp({credential:admin.credential.cert(serviceAccount),databaseURL:"https://diary-7919f.firebaseio.com"}),db=admin.firestore(app),messaging=admin.messaging(app),memoriesRef=db.collection("memories"),usersRef=db.collection("users");exports.scheduledFunction=functions.pubsub.schedule("every 5 minutes").onRun(function(e){var o=new Date;return memoriesRef.where("notificationTimestamp","<",o).where("notificationSent","==",!1).get().then(function(e){var r=[];return e.forEach(function(e){var o=e.data(),n=o.owner,i=o.type,t=o.videoName;r.push({ownerUid:n,mediaType:i,videoName:t,docRef:e.ref})}),console.log("notificationsToSend"),console.log(r),r}).then(function(t){var o=[];return t.forEach(function(e){o.push(usersRef.doc(e.ownerUid).get())}),console.log("promises"),console.log(o),Promise.all(o).then(function(e){for(i=0;i<e.length;i++){var o={notification:{title:"Memory",body:"You have a memory"},data:{videoName:t[i].videoName}},n=e[i].data().notificationTokens;return console.log("tokens"),console.log(n),console.log("payload"),console.log(o),messaging.sendToDevice(n,o).then(function(e){var o=e.results;console.log("results"),console.log(o),e.results.forEach(function(e,o){var n=e.error;n&&("messaging/invalid-registration-token"===n.code||n.code)});var n=!1;return e.results.forEach(function(e){null!==e.messageId&&(n=!0)}),console.log("oneDeviceGotTheMessage"),console.log(n),n&&t[i].docRef.update({notificationSent:!0}),null})}return null})})});